# TACT TextMate grammar file
---
name: tact
scopeName: source.tact
fileTypes: [tact]
foldingStartMarker: "\\{s*$"
foldingStopMarker: "^\\s*\\}"

variables:
  hexNumber: \b0(?:x|X)[0-9a-fA-F][0-9a-fA-F_]*\b
  decNumber: \b[0-9]+\b
  anyNumber: (?:{{hexNumber}})|(?:{{decNumber}})

patterns:
  - include: "#comments"
  - include: "#import"
  - include: "#struct"
  - include: "#numeric"
  - include: "#keywords"
  - include: "#variables"
  - include: "#strings"

repository:
  import:
    name: meta.import.tact
    begin: \b(import)\b\s*
    beginCaptures:
      '1':
        name: keyword.other.import.tact
    end: \s*(;)
    endCaptures:
      '1':
        name: punctuation.terminator.tact
    patterns:
      - include: "#comments"
      - include: "#strings"
      # - name: invalid.illegal.character_not_allowed_here.tact
      #   match: ^(\"[.]*\")

  # structure and message definition
  struct:
    name: meta.struct.tact
    begin: \b(struct|message)\b\s*(?:\(\s*({{anyNumber}})\s*\))?\s*([\w]+)\s*({)\s+
    beginCaptures:
      '1':
        name: keyword.other.struct
      '2':
        name: constant.numeric
      '3':
        name: entity.name.type.tact
      '4':
        name: punctuation.section.begin.bracket.curly.tact
    end: (})
    endCaptures:
      '1':
        name: punctuation.section.end.bracket.curly.tact
    patterns:
      - include: "#comments"
      - include: "#field"

  field:
    name: meta.struct.field.tact
    begin: "\\s*([\\w]+)\\s*:\\s*([\\w]+)\\s*"
    beginCaptures:
      '1':
        name: variable.other.definition.tact
      '2':
        name: entity.name.type.tact
    end: "(;)"
    endCaptures:
      '1':
        name: punctuation.terminator.tact
  
  keywords:
    patterns:
      - name: keyword.control.tact
        match: \b(if|else|while|do|until|repeat|return|extends|mutates|native|let|fun|self|is|initOf|map|get|as)\b
      - name: keyword.operator
        match: (?<=\s)(<=>|>=|<=|!=|==|\^>>|\~>>|>>|<<|\/%|\^%|\~%|\^\/|\~\/|\+=|-=|\*=|\/=|~\/=|\^\/=|%=|\^%=|<<=|>>=|~>>=|\^>>=|&=|\|=|\^=|\^|=|~|\/|%|-|\*|\+|>|<|&|\||:|\?)(?=\s)
      - name: keyword.other
        match: \b(false|true)\b
  strings:
    name: string.quoted.double.tact
    begin: '"'
    end: '"'
  numeric:
    name: constant.numeric
    match: "{{anyNumber}}"
  comments:
    patterns:
      - name: comment.line
        match: \/\/(.*)
      - name: comment.block
        begin: /\*
        end: \*/
  variables:
    patterns:
      - match: (?!")(`([^`]+)`|((?=_)_|(?={){|(?=})}|(?![_`{}]))([^;,\[\]\(\)\s~.]+))
        name: variable.name
